<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="kr.or.profit.mapper.AdminMemberMapper">

    <!-- 트레이너 프로세스 디테일 -->
    <select id="selectProcessDetailBySeq" parameterType="String" resultType="ProcessVO">
        select  p.process_seq, p.member_id, p.file_seq, p.trainer_award, p.trainer_career, 
		        p.trainer_gym, p.process_status, p.process_finish_date, p.admin_memo,
		        p.in_date, p.up_date,
		        m.member_name, m.member_mobile, m.member_email, m.member_gender
		from process p
		inner join member m
		on (p.member_id = m.member_id)
		where p.process_seq = #{memberId}
    </select>
    
	<!-- 트레이너 프로세스 디테일-첨부파일 가져오기-->
    <select id="selectProcessFile" parameterType="String" resultType="egovMap">
	    select file_seq, file_detail_seq, file_real_name, file_path 
		from attach_file
		where file_seq = #{fileSeq}
	</select>
    
    
    
    
    <!-- 관리자-트레이너 정보 수정 -->
    <!-- 1.attach_file 테이블에 row 추가 -->
    <insert id="insertProcessFile" parameterType="java.util.Map">
		<foreach collection="list" item="item" index="index"
			open="INSERT ALL" close="SELECT * FROM DUAL" separator=" ">

			into
			attach_file
			(
			file_seq,
			file_detail_seq,
			file_real_name,
			file_save_name,
			file_path,
			in_user_id,
			in_date,
			up_user_id,
			up_date
			)
			values

			(
			#{item.fileSeq},
			#{item.fileDetailSeq},
			#{item.fileRealName},
			#{item.fileSaveName},
			#{item.filePath},
			#{item.inUserId},
			sysdate,
			#{item.upUserId, jdbcType=VARCHAR},
			sysdate
			)


		</foreach>
	</insert>
    
    
    
    
    
    
    
    
    
    
    
    
    <!-- 관리자-트레이너승인, 숫자 보여주는 표 -->
	<select id="selectProcessNumberList" resultType="ProcessVO">
	    select status_a,status_b,status_c, status_date
		from    
		    (
		    select  (select count(*) from process where process_status = 'A') as status_a,
		            (select count(*) from process where process_status = 'B') as status_b,
		            (select count(*) from process where process_status = 'C') as status_c,
		            (select count(*) from process where to_char(up_date, 'YYYY/MM/DD') = to_char(sysdate, 'YYYY/MM/DD')) status_date,
		            rownum as rm
		    from process
		    ) tbl
		where rm = 1
	</select>
   	
	
	<!-- 관리자-트레이너승인, 리스트 부분 -->
 	<select id="selectProcessList" parameterType="Criteria" resultType="egovMap">
 	    
 	    select	tt.rm, tt.process_seq, tt.member_id,
 	    		tt.member_name,
 	    		tt.process_status, tt.process_finish_date,
				tt.in_user_id, tt.in_date, tt.up_user_id, tt.up_date
 	    from
 	    	(
	 	    select 	rownum as rm, tbl.process_seq, tbl.member_id,
	 	    		tbl.member_name,
	 	    		tbl.process_status, tbl.process_finish_date,
					tbl.in_user_id, tbl.in_date, tbl.up_user_id, tbl.up_date
	 	    from ( 
		 	    select  process_seq, member_id,
		 	    		(select member_name from member where process.member_id = member_id) as member_name, 
				        process_status, process_finish_date,
				        in_user_id, in_date, up_user_id, up_date
				from    process
				where	1=1
						<if test="selStatus != null and selStatus != '' ">
						    and process_status = #{selStatus}
						</if>
						<if test="selDate != null and selDate != '' ">
						    <choose>
						        <when test='selStatus.equals("A")'>
						            and to_char(in_date, 'YYYYMMDD') = #{selDate}
						        </when>
						        <otherwise>
						            and to_char(up_date, 'YYYYMMDD') = #{selDate}
						        </otherwise>
						    </choose>
						</if>
						<if test="selIdentity != null and selIdentity != '' ">
						    <choose>
						        <when test='selIdentity.equals("이름")'>
						            and member_id = #{searchKeyword}
						        </when>
						        <otherwise>
						            and (select member_name from member where process.member_id = member_id) = #{searchKeyword}
						        </otherwise>
						    </choose>
						</if>
				order by in_date desc
			) tbl
		) tt
		where tt.rm between #{rowStart} and #{rowEnd}
		
 	</select>
 	
 	
 	<!-- 페이징용 전체 수 cnt -->
 	<select id="selectProcessListCnt" parameterType="Criteria" resultType="int">
 	    select count(*)
   		from    process
		where	1=1
				<if test="selStatus != null and selStatus != '' ">
				    and process_status = #{selStatus}
				</if>
				<if test="selDate != null and selDate != '' ">
				    <choose>
				        <when test='selStatus.equals("신청")'>
				            and to_char(in_date, 'YYYYMMDD') = #{selDate}
				        </when>
				        <otherwise>
				            and to_char(up_date, 'YYYYMMDD') = #{selDate}
				        </otherwise>
				    </choose>
				</if>
				<if test="selIdentity != null and selDate != '' ">
				    <choose>
				        <when test='selIdentity.equals("이름")'>
				            and member_id = #{searchKeyword}
				        </when>
				        <otherwise>
				            and (select member_name from member where process.member_id = member_id) = #{searchKeyword}
				        </otherwise>
				    </choose>
				</if>
		order by in_date desc
 	</select>
 	
    <!-- 관라지-신청서 검토로 update -->
    <update id="updateStatusB" parameterType="String">
        update process
		set process_status = 'B',
		    up_date = sysdate
		where process_seq = #{processSeq}
    </update>
 	
 	
 	
 	
 	
 	
 	
 	
 	
 	
 	
 	
 	
 	
 	
 	
 	
 	
</mapper>
