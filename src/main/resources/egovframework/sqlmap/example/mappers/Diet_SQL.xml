<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="kr.or.profit.mapper.DietMapper">

	<!-- 선택한 이용권 정보 조회 -->
	<select id="selectTicketCategory" resultType="egovMap">
	    SELECT 
	    TICKET_CATEGORY_SEQ, 
	    TICKET_NAME, 
	    TICKET_PRICE, 
	    TICKET_CNT
		FROM 
		TICKET_CATEGORY 
		WHERE 
		TICKET_CATEGORY_SEQ = #{ticketCategorySeq}
	</select>
	
	<!-- 이용권 구매내역 추가 -->
	<insert id="insertBuyTicket">
		<selectKey order="BEFORE" keyProperty="buyTicketSeq"
			resultType="String">
			SELECT NVL(MAX(TO_NUMBER(BUY_TICKET_SEQ)),0)+1 FROM
			BUY_TICKET
		</selectKey>
		<![CDATA[
			INSERT INTO 
			BUY_TICKET
			(
			BUY_TICKET_SEQ,
			TICKET_CATEGORY_SEQ, 
			TICKET_REMAIN, 
			TICKET_REFUND_FLAG, 
			IN_USER_ID, IN_DATE, 
			UP_USER_ID, 
			UP_DATE
			) 	 
			VALUES 
			(
			#{buyTicketSeq}, 
			#{ticketCategorySeq}, 
			#{ticketRemain}, 
			'N', 
			#{inUserId}, 
			SYSDATE, 
			#{upUserId}, 
			SYSDATE
			)
		]]>
	</insert>
	
	<!-- 사용가능한 이용권 존재여부 확인 -->
	<select id="selectAvailableTicket" resultType="int">
	    SELECT COUNT(*)
		FROM BUY_TICKET
		WHERE IN_USER_ID = #{memberId}
		AND TICKET_AVAIL_FLAG = 'Y'
	</select>
	
	
	<!-- 상담 프로필 등록 -->
	<insert id="insertChatProfile">
		
		<selectKey resultType="string" keyProperty="fileSeq"
			order="BEFORE">
			SELECT
			NVL(MAX(TO_NUMBER(FILE_SEQ)),0)
			FROM ATTACH_FILE
		</selectKey>
		
		
		<![CDATA[
			INSERT INTO 
			CHAT_PROFILE
			(
			CHAT_PROFILE_SEQ,
			FILE_SEQ,
			CHAT_PROFILE_ID,
			CHAT_PROFILE_INTRO, 
			CHAT_PROFILE_MEMO, 
			CHAT_PROFILE_PRIVATE, 
			IN_USER_ID, 
			IN_DATE, 
			UP_USER_ID, 
			UP_DATE
			)
		    VALUES 
		    (
		    (SELECT NVL(MAX(TO_NUMBER(CHAT_PROFILE_SEQ)),0)+1 FROM
			CHAT_PROFILE),
		    #{fileSeq},
		    #{chatProfileId},
		    #{chatProfileIntro},
		    #{chatProfileMemo},
		    'N',
		    #{inUserId},
		    SYSDATE,
		    #{upUserId},
		    SYSDATE
		    )
		]]>
	</insert>
	
	<!-- 상담 프로필 등록 여부 -->
	<select id="selectRegisterProfile" resultType="int">
	    SELECT COUNT(*) 
		FROM CHAT_PROFILE
		WHERE CHAT_PROFILE_PRIVATE = 'N' 
		AND CHAT_PROFILE_ID=#{memberId}
	</select>
	
	<!-- 상담 프로필 목록 조회 -->
	<select id="selectChatProflieList" resultType="egovMap">
	    SELECT CHAT_PROFILE_SEQ, CHAT_PROFILE_ID, MEMBER_NAME, A.FILE_SEQ, CHAT_PROFILE_INTRO, FILE_PATH
		FROM CHAT_PROFILE A
		LEFT JOIN MEMBER B ON
		(A.CHAT_PROFILE_ID = B.MEMBER_ID)
		LEFT JOIN ATTACH_FILE C ON
		(A.FILE_SEQ = C.FILE_SEQ)
		WHERE CHAT_PROFILE_PRIVATE = 'N'
	</select>
	
	
	<insert id="insertProcessFile" parameterType="java.util.Map">
		<foreach collection="list" item="item" index="index"
			open="INSERT ALL" close="SELECT * FROM DUAL" separator=" ">

			into
			attach_file
			(
			file_seq,
			file_detail_seq,
			file_real_name,
			file_save_name,
			file_path,
			in_user_id,
			in_date,
			up_user_id,
			up_date
			)
			values

			(
			(
			select
			NVL(max(to_number(file_seq)),0) + 1
			from
			attach_file),
			#{item.fileDetailSeq},
			#{item.fileRealName},
			#{item.fileSaveName},
			#{item.filePath},
			#{item.inUserId},
			sysdate,
			#{item.upUserId, jdbcType=VARCHAR},
			sysdate
			)


		</foreach>
	</insert>
</mapper>
