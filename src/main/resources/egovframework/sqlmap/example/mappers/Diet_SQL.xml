<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="kr.or.profit.mapper.DietMapper">

	<!-- 선택한 이용권 정보 조회 -->
	<select id="selectTicketCategory" resultType="egovMap">
	    SELECT 
	    TICKET_CATEGORY_SEQ, 
	    TICKET_NAME, 
	    TICKET_PRICE, 
	    TICKET_CNT
		FROM 
		TICKET_CATEGORY 
		WHERE 
		TICKET_CATEGORY_SEQ = #{ticketCategorySeq}
	</select>
	
	<!-- 이용권 구매내역 추가 -->
	<insert id="insertBuyTicket">
		<selectKey order="BEFORE" keyProperty="buyTicketSeq"
			resultType="String">
			SELECT NVL(MAX(TO_NUMBER(BUY_TICKET_SEQ)),0)+1 FROM
			BUY_TICKET
		</selectKey>
		<![CDATA[
			INSERT INTO 
			BUY_TICKET
			(
			BUY_TICKET_SEQ,
			TICKET_CATEGORY_SEQ, 
			TICKET_REMAIN, 
			TICKET_REFUND_FLAG, 
			IN_USER_ID, IN_DATE, 
			UP_USER_ID, 
			UP_DATE
			) 	 
			VALUES 
			(
			#{buyTicketSeq}, 
			#{ticketCategorySeq}, 
			#{ticketRemain}, 
			'N', 
			#{inUserId}, 
			SYSDATE, 
			#{upUserId}, 
			SYSDATE
			)
		]]>
	</insert>
	
	<!-- 사용가능한 이용권 존재여부 확인 -->
	<select id="selectAvailableTicket" resultType="int">
	    SELECT COUNT(*)
		FROM BUY_TICKET
		WHERE IN_USER_ID = #{memberId}
		AND TICKET_AVAIL_FLAG = 'Y'
	</select>

</mapper>
